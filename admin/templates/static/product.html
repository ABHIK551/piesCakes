{% extends "static/base.html" %}
{% load static %}
{% block content %}
<main class="content">
<div class="container d-flex flex-column">
    <div class="row vh-100">
        
        <!-- Header Card with Title & Button -->
        <div style="height:80px;" class="card p-3 mb-0 d-flex flex-row justify-content-between align-items-center">
            <h3 class="m-0">Products</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                Add Product
            </button>
        </div>

        <!-- Card with Table -->
        <div class="card mt-0">
           <div class="table-wrapper">
            <table class="table table-hover my-0 table-bordered">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Image</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Ingredients</th>
                        <th>Allergen Info</th>
                        <th>Price</th>
                        <th>Discount Price</th>
                        <th>Stock Status</th>
                        <th>Serving Size</th>
                        <th>Total Stock</th>
                        <th>Reorder Level</th>
                        <th>Weight</th>
                        <th>Cake Size</th>
                        <th>Flavor Variants</th>
                        <th>Add-ons</th>
                        <th>Calories</th>
                        <th>Nutrition Facts</th>
                        <th>Prep Time</th>
                        <th>Delivery Option</th>
                        <th>Shelf Life</th>
                        <th>Tags</th>
                        <th>Reviews</th>
                        <th>Related Products</th>
                        <th>Total Sales</th>
                        <th>Status</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    <!-- Data will be inserted here dynamically -->
                </tbody>
            </table>
           </div>
        </div>
        <ul id="pagination" class="pagination"></ul>
    </div>
</div>
</main>

<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm" enctype="multipart/form-data" class="container mt-4">
                    <!-- Basic Details -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Basic Details</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Product Name:</label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Category:</label>
                                <select name="category" class="form-select">
                                    <option value="38">Cakes</option>
                                    <option value="39">Cookies</option>
                                    <option value="40">Bread</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editCategoryStatus" class="form-label">Status</label>
                                <select class="form-select" id="productStatus" name="status">
                                    <option value="1">Active</option>
                                    <option value="2">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Description:</label>
                                <textarea name="description" class="form-control"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ingredients:</label>
                                <textarea name="ingredients" class="form-control"></textarea>
                            </div>
                        </div>
                       
                        <div class="mb-3">
                            <label class="form-label">Allergen Information:</label>
                            <input type="text" name="allergen_info" class="form-control">
                        </div>
                    </fieldset>
                    
                    <!-- Pricing & Availability -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Pricing & Availability</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Price:</label>
                                <input type="number" name="price" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Discount Price:</label>
                                <input type="number" name="discount_price" class="form-control">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock Availability:</label>
                                <select name="stock" class="form-select">
                                    <option value="in_stock">In Stock</option>
                                    <option value="out_of_stock">Out of Stock</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Serving Size:</label>
                                <input type="text" name="serving_size" class="form-control">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Stock Details -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Stock Details</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Total Stock Quantity:</label>
                                <input type="number" name="total_stock" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Reorder Level:</label>
                                <input type="number" name="reorder_level" class="form-control">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Customization Options -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Customization Options</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cake Size:</label>
                                <select name="cake_size" class="form-select">
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Flavor Variants:</label>
                                <input type="text" name="flavor_variants" class="form-control">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Images & Media -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Images & Media</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Product Images:</label>
                                <input type="file" name="product_images" id="productImage" class="form-control" multiple>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Video Demonstration:</label>
                                <input type="file" name="video_demo" class="form-control">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Nutritional Information -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Nutritional Information</legend>
                        <div class="mb-3">
                            <label class="form-label">Calories per Serving:</label>
                            <input type="text" name="calories" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fat, Sugar, Protein, etc.:</label>
                            <textarea name="nutrition_facts" class="form-control"></textarea>
                        </div>
                    </fieldset>
                    
                    <!-- Additional Features -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Additional Features</legend>
                        <div class="mb-3">
                            <label class="form-label">Tags & Labels:</label>
                            <input type="text" name="tags" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Customer Reviews & Ratings:</label>
                            <textarea name="reviews" class="form-control"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Related Products:</label>
                            <input type="text" name="related_products" class="form-control">
                        </div>
                    </fieldset>
                    
                    <button type="submit" class="btn btn-primary btn-sm">Save Product</button>
                </form>
                
            </div>
        </div>
    </div>
</div>
<!-- Edit Category Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm" enctype="multipart/form-data" class="container mt-4">
                    <input type="hidden" id="editProductId" name="product_id">
                    <!-- Basic Details -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Basic Details</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Product Name:</label>
                                <input type="text" id="editProductName" name="name" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Category:</label>
                                <select id="editProductCategory" name="category" class="form-select">
                                    <option value="38">Cakes</option>
                                    <option value="39">Cookies</option>
                                    <option value="40">Bread</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="editProductStatus" name="status">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Description:</label>
                                <textarea id="editProductDescription" name="description" class="form-control"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ingredients:</label>
                                <textarea id="editProductIngredients" name="ingredients" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Allergen Information:</label>
                            <input type="text" id="editProductAllergen" name="allergen_info" class="form-control">
                        </div>
                    </fieldset>
                    
                    <!-- Pricing & Availability -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Pricing & Availability</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Price:</label>
                                <input type="number" id="editProductPrice" name="price" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Discount Price:</label>
                                <input type="number" id="editProductDiscountPrice" name="discount_price" class="form-control">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock Availability:</label>
                                <select id="editProductStock" name="stock" class="form-select">
                                    <option value="in_stock">In Stock</option>
                                    <option value="out_of_stock">Out of Stock</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Serving Size <b>(g)</b>:</label>
                                <input type="text" id="editProductServingSize" name="serving_size" class="form-control">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Stock Details -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Stock Details</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Total Stock Quantity:</label>
                                <input type="number" id="editProductTotalStock" name="total_stock" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Reorder Level:</label>
                                <input type="number" id="editProductReorderLevel" name="reorder_level" class="form-control">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Customization Options -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Customization Options</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cake Size:</label>
                                <select id="editProductCakeSize" name="cake_size" class="form-select">
                                    <option value="small">Small</option>
                                    <option value="medium">Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Flavor Variants:</label>
                                <input type="text" id="editProductFlavorVariants" name="flavor_variants" class="form-control">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Images & Media -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Images & Media</legend>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Product Images:</label>
                                <input type="file" id="editProductImages" name="product_images" class="form-control" multiple>
                                <img id="editProductPreviewImages" src="" class="mt-2" style="max-width: 100px; display: none;">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Video Demonstration:</label>
                                <input type="file" id="editProductVideoDemo" name="video_demo" class="form-control">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Nutritional Information -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Nutritional Information</legend>
                        <div class="mb-3">
                            <label class="form-label" for="editProductCalories">Calories per Serving:</label>
                            <input type="text" id="editProductCalories" name="calories" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="editProductNutritionFacts">Fat, Sugar, Protein, etc.:</label>
                            <textarea id="editProductNutritionFacts" name="nutrition_facts" class="form-control"></textarea>
                        </div>
                    </fieldset>

                    <!-- Additional Features -->
                    <fieldset class="border p-3 mb-4 rounded">
                        <legend class="w-auto px-2">Additional Features</legend>
                        <div class="mb-3">
                            <label class="form-label" for="editProductTags">Tags & Labels:</label>
                            <input type="text" id="editProductTags" name="tags" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="editProductReviews">Customer Reviews & Ratings:</label>
                            <textarea id="editProductReviews" name="reviews" class="form-control"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="editProductRelatedProducts">Related Products:</label>
                            <input type="text" id="editProductRelatedProducts" name="related_products" class="form-control">
                        </div>
                    </fieldset>

                    <button type="submit" class="btn btn-primary btn-sm">Update Product</button>
                </form>
                
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const addProductModal = document.getElementById("addProductModal");
    const editProductModal = document.getElementById("editProductModal");

    // Fetch categories when the Add Product modal is shown
    addProductModal.addEventListener("show.bs.modal", function () {
        fetchCategories();
    });

    // Function to fetch and populate categories for both modals
    function fetchCategories(selectedCategoryId = null) {
        fetch("http://127.0.0.1:8000/api/categories-list/")
            .then(response => response.json())
            .then(data => {
                console.log("API Response:", data); // Debugging
                if (data.categories.main_categories) {
                    populateCategoryDropdown(
                        document.querySelector("#addProductModal select[name='category']"),
                        data.categories.main_categories
                    );
                    populateCategoryDropdown(
                        document.querySelector("#editProductModal select[name='category']"),
                        data.categories.main_categories,
                        selectedCategoryId
                    );
                }
            })
            .catch(error => console.error("Error fetching categories:", error));
    }

    // Function to populate the category dropdown
    function populateCategoryDropdown(selectElement, categories, selectedCategoryId = null) {
        if (!selectElement) return; // Prevent errors

        selectElement.innerHTML = ""; // Clear existing options

        categories.forEach(category => {
            const option = document.createElement("option");
            option.value = category.id;
            option.textContent = category.name;
            if (selectedCategoryId && category.id == selectedCategoryId) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
    }
});


document.addEventListener("DOMContentLoaded", function () {
    const productForm = document.getElementById("productForm");
    const imageInput = document.getElementById("productImage"); // Make sure you have this input field

    productForm.addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent default form submission

        // ✅ Check if an image is selected
        if (imageInput.files.length > 0) {
            const imageSize = imageInput.files[0].size; // File size in bytes (B)
            const maxSize = 2 * 1024 * 1024; // 2MB in bytes

            if (imageSize > maxSize) {
                let addProductModal = bootstrap.Modal.getInstance(document.getElementById("addProductModal"));
                addProductModal.hide(); // Close modal after success
                showToast("❌ Unable to upload. Image size must be under 2MB!", "danger");
                return; // Stop form submission
            }
        }

        const formData = new FormData(productForm); // Create FormData object

        fetch("http://127.0.0.1:8000/api/products/create/", {
            method: "POST",
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide the modal properly
                let addCategoryModal = document.getElementById("addProductModal");
                let modalInstance = bootstrap.Modal.getInstance(addCategoryModal);
                modalInstance.hide();

                // Remove modal backdrop manually (if still present)
                document.querySelectorAll(".modal-backdrop").forEach(backdrop => backdrop.remove());

                // Show success toast message
                showToast("✅ Product Created Successfully!", "success");
                productForm.reset();
            } else {
                showToast("❌ Failed to add product!", "danger");
                console.error("Error:", data);
            }
        })
        .catch(error => {
            showToast("❌ Server error. Please try again!", "danger");
            console.error("Fetch error:", error);
        });
    });
});


</script>
<script>
async function editProduct(productId, products) {
    // Parse product data
    let productData = JSON.parse(decodeURIComponent(products));

    console.log("productData", productData);
    console.log("productId", productId, typeof productId);

    // Ensure productId is a number
    let product = productData.find(p => p.id === Number(productId));

    console.log("product", product);

    if (!product) {
        console.error("Product not found!");
        return;
    }

    // Set form values
    document.getElementById("editProductName").value = product.name || "";
    document.getElementById("editProductCategory").value = product.category.id || "";
    document.getElementById("editProductStatus").value = product.status || "Inactive";
    document.getElementById("editProductDescription").value = product.description || "";
    document.getElementById("editProductIngredients").value = product.ingredients || "";
    document.getElementById("editProductAllergen").value = product.allergen_info || "";
    document.getElementById("editProductPrice").value = product.price || 0;
    document.getElementById("editProductDiscountPrice").value = product.discount_price || 0;
    document.getElementById("editProductStock").value = product.stock_status || 0;
    document.getElementById("editProductServingSize").value = product.serving_size || 0; 
    document.getElementById("editProductTotalStock").value = product.total_stock || 0;
    document.getElementById("editProductReorderLevel").value = product.reorder_level || 0;
    document.getElementById("editProductCakeSize").value = product.cake_size;   
    document.getElementById("editProductFlavorVariants").value = product.flavor_variants;
    // Show image preview if available
    let imagePreview = document.getElementById("editProductPreviewImages");
    if (product.product_images) {
        imagePreview.src = `data:image/png;base64,${product.product_images}`;
        imagePreview.style.display = "block";
    } else {
        imagePreview.style.display = "none";
    }
    document.getElementById("editProductCalories").value = product.calories || "";
    document.getElementById("editProductNutritionFacts").value = product.nutrition_facts || "";
    document.getElementById("editProductTags").value = product.tags || "";
    document.getElementById("editProductReviews").value = product.reviews || "";
    document.getElementById("editProductRelatedProducts").value = product.related_products || "";
    document.getElementById("editProductId").value = product.id;
    // Show the modal
    let editModal = new bootstrap.Modal(document.getElementById("editProductModal"));
    editModal.show();
}


let currentPage = 1;  // ✅ Move this to the global scope
    const pageSize = 5;

    // ✅ Move loadProductData() outside so it's globally accessible
    function loadProductData(page = 1) {
        console.log(`Fetching data for page ${page}`); // Debugging log
        document.getElementById("loader-container").style.display = "flex";

        fetch(`http://127.0.0.1:8000/api/products-list/?page=${page}&pageSize=${pageSize}`)
            .then(response => response.json())
            .then(data => {
                console.log("API Response:", data); // Debugging log
                const products = data.products.products;
                // Convert category object to a JSON string & escape single quotes
			    let productData = encodeURIComponent(JSON.stringify(products));
                const tableBody = document.getElementById('productTableBody');
                tableBody.innerHTML = '';

               products.forEach(product => {
                    const row = document.createElement('tr');

                    // Insert product details into table cells
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>
                            <img src="data:image/png;base64,${product.product_images}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;">
                        </td>
                        <td>${product.category ? product.category.name : 'N/A'}</td>
                        <td>${product.description || 'N/A'}</td>
                        <td>${product.ingredients || 'N/A'}</td>
                        <td>${product.allergen_info || 'N/A'}</td>
                        <td>${product.price}</td>
                        <td>${product.discount_price || 'N/A'}</td>
                        <td>${product.stock_status}</td>
                        <td>${product.serving_size || 'N/A'}</td>
                        <td>${product.total_stock}</td>
                        <td>${product.reorder_level}</td>
                        <td>${product.weight || 'N/A'}</td>
                        <td>${product.cake_size || 'N/A'}</td>
                        <td>${product.flavor_variants || 'N/A'}</td>
                        <td>${product.add_ons || 'N/A'}</td>
                        <td>${product.calories || 'N/A'}</td>
                        <td>${product.nutrition_facts || 'N/A'}</td>
                        <td>${product.prep_time || 'N/A'}</td>
                        <td>${product.delivery_option || 'N/A'}</td>
                        <td>${product.shelf_life || 'N/A'}</td>
                        <td>${product.tags || 'N/A'}</td>
                        <td>${product.reviews || 'N/A'}</td>
                        <td>${product.related_products || 'N/A'}</td>
                        <td>${product.total_sales}</td>
                        <td class="${product.status === 'Active' ? 'bg-success text-white' : 'bg-danger text-white'}">
                            ${product.status}
                        </td>
                        <td class="d-none d-md-table-cell">${new Date(product.created_at).toLocaleString()}</td>
                        <td class="d-none d-md-table-cell">${product.updated_at ? new Date(product.updated_at).toLocaleString() : ""}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editProduct('${product.id}', '${productData}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
                        </td>
                        
                    `; 
                    tableBody.appendChild(row);
                });

                document.getElementById("loader-container").style.display = "none";
                updatePagination(data.page, data.totalPages);
            })
            .catch(error => {
                console.error('Error fetching products:', error);
            });
    }

    function updatePagination(page, totalPages) {
        let pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        if (page > 1) {
            pagination.innerHTML += `<li class="page-item">
                <a class="page-link" href="#" onclick="return changePageProduct(${page - 1}, event)">Previous</a>
            </li>`;
        }

        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `<li class="page-item ${i === page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="return changePageProduct(${i}, event)">${i}</a>
            </li>`;
        }

        if (page < totalPages) {
            pagination.innerHTML += `<li class="page-item">
                <a class="page-link" href="#" onclick="return changePageProduct(${page + 1}, event)">Next</a>
            </li>`;
        }
    }

    // ✅ This function now correctly calls loadProductData()
    function changePageProduct(page, event) {
        if (event) event.preventDefault();
        console.log(`Changing to page ${page}`); // Debugging log
        currentPage = page;
        loadProductData(currentPage);
        return false;
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadProductData(currentPage); // ✅ Load initial page after DOM is ready
    });

    window.deleteProduct = function (id) {
		if (confirm("Are you sure you want to delete this product?")) {
			fetch(`http://127.0.0.1:8000/api/product/delete/${id}/`, { method: "DELETE" })
				.then(response => {
					if (!response.ok) {
						throw new Error(`HTTP error! Status: ${response.status}`);
					}
					return response.json().catch(() => ({})); // Ensure safe JSON parsing
				})
				.then(data => {
					console.log(data)
					if (data.success) {
						showToast("Product deleted successfully!", "success")
						changePageProduct(1, event);
						window.location.reload();
					} else {
						showToast("Failed to delete product.", "danger");
					}
				})
		}
	};

    document.getElementById("editProductForm").addEventListener("submit", updateProduct);
async function updateProduct(event) {
    event.preventDefault(); // ✅ Prevent form submission & page reload

    let form = document.getElementById("editProductForm");
    let formData = new FormData(form);

    let productId = document.getElementById("editProductId").value;
    let imageInputProduct = document.getElementById("editProductImages");

    // ✅ Check if an image is selected
    if (imageInputProduct.files.length > 0) {
        const imageSize = imageInputProduct.files[0].size; // File size in bytes (B)
        const maxSize = 2 * 1024 * 1024; // 2MB in bytes

        if (imageSize > maxSize) {
            let editModal = bootstrap.Modal.getInstance(document.getElementById("editProductModal"));
            editModal.hide(); // Close modal after success
            showToast("❌ Unable to upload. Image size must be under 2MB!", "danger");
            return; // Stop form submission
        }

        formData.append("image", imageInputProduct.files[0]);
    }

    try {
        let response = await fetch(`http://127.0.0.1:8000/api/product/${productId}/`, {
            method: "POST", 
            body: formData
        });

        let result = await response.json();

        if (result.success) { // ✅ Correct success check
            let editModal = bootstrap.Modal.getInstance(document.getElementById("editProductModal"));
            editModal.hide(); // Close modal after success

            showToast("✅ Product updated successfully!", "success");
            setTimeout(() => {
                location.reload(); // ✅ Refresh page after 5 sec
            }, 5000);
        } else {
            showToast("❌ Product update failed!", "danger");
            setTimeout(() => {
                location.reload(); // ✅ Refresh page after 5 sec
            }, 5000);
        }
    } catch (error) {
        console.error("Error updating product:", error);
        showToast("❌ An error occurred!", "danger");
    }
}


    </script>

{%endblock%}