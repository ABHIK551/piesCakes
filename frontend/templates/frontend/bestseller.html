<section class="bestsellers">
  <style>
/* Optional Styling */
.product-info {
  padding: 1rem;
}
.size-buttons {
  margin-top: 0.5rem;
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.size-btn {
  background: #f1f1f1;
  border: 1px solid lightgray;
  padding: 4px 10px;
  cursor: pointer;
  font-size: 0.85rem;
  border-radius: 4px;
  background-color: #FFFFFA;
  color: black;
}
.size-btn.active {
  background-color: #FF9800;
  color: #fff;
  border-color: ##FF9800;
}
.price del {
  margin-left: 8px;
  color: #888;
  font-size: 0.9em;
}
</style>
    <div class="bestsellers-wrapper">
      <h2><span><b>Bestsellers</b></span></h2>
      <div class="swiper bestsellers-slider">
        <div class="swiper-wrapper" id="bestsellerWrapper">
          <!-- JS will inject skeleton cards here -->
        </div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>
  
<script>
    // function loadBestsellers() {
    //     fetch(`/api/products-list/?page=1&pageSize=100`)
    //         .then(response => response.json())
    //         .then(data => {
    //             const allProducts = data.products.products;
    
    //             // Normalize reviews and sort by number of reviews (assume it's an array or number)
    //             const sorted = allProducts
    //                 .map(p => {
    //                     const reviewCount = Array.isArray(p.reviews) ? p.reviews.length : (parseInt(p.reviews) || 0);
    //                     return { ...p, reviewCount };
    //                 })
    //                 .sort((a, b) => b.reviewCount - a.reviewCount)
    //                 .slice(0, 10); // Top 10 only
    
    //             const wrapper = document.querySelector('.bestsellers-slider .swiper-wrapper');
    //             wrapper.innerHTML = ''; // Clear current slides
    
    //             sorted.forEach(product => {
    //                 const badgeLabel = product.reviewCount > 50 ? 'HOT' : (product.reviewCount > 20 ? 'TRENDING' : '');
    //                 const badgeHTML = badgeLabel ? `<span class="badge sale">${badgeLabel}</span>` : '';
    //                 const category = product.category ? product.category.name : 'Unknown';
    //                 const rating = '⭐'.repeat(Math.min(5, Math.floor(product.reviewCount / 10))) + '☆'.repeat(5 - Math.min(5, Math.floor(product.reviewCount / 10)));
                        
    //                 const slide = `
    //                     <div class="swiper-slide product bestseller-product">
    //                         <div class="product-image">
    //                             <img src="data:image/png;base64,${product.product_images}" alt="${product.name}" loading="lazy">
    //                             ${badgeHTML}
    //                         </div>
    //                         <div class="product-info">
    //                             <p class="category">${category}</p>
    //                             <h3>${product.name}</h3>
    //                             <div class="rating">${rating}</div>
    //                             <p class="price">
    //                                 ₹${product.discount_price ? (product.price - product.discount_price).toFixed(2) : product.price.toFixed(2)}
    //                                 ${product.discount_price ? `<strike>₹${product.price.toFixed(2)}</strike>` : ''}
    //                             </p>                           
    //                         </div>
    //                     </div>
    //                 `;
    //                 wrapper.innerHTML += slide;
    //             });
    //         })
    //         .catch(error => {
    //             console.error('Error loading bestsellers:', error);
    //         });
    // }
    
    // document.addEventListener('DOMContentLoaded', loadBestsellers);
    
//     document.addEventListener("DOMContentLoaded", loadBestsellers);

// function loadBestsellers() {
//   const wrapper = document.getElementById("bestsellerWrapper");
//   wrapper.innerHTML = "";

//   // Insert skeletons
//   for (let i = 0; i < 5; i++) {
//     const skel = document.createElement("div");
//     skel.className = "swiper-slide skeleton-card loading";
//     skel.innerHTML = `
//       <div class="skeleton-image"></div>
//       <div class="skeleton-text"></div>
//       <div class="skeleton-text" style="width:60%;"></div>
//     `;
//     wrapper.appendChild(skel);
//   }

//   fetch(`/api/products-list/?page=1&pageSize=10`)
//     .then(res => res.json())
//     .then(data => {
//       if (!data.products) throw new Error("No products");
//       wrapper.innerHTML = "";

//       data.products.products.forEach((product, index) => {
//         const slide = document.createElement("div");
//         slide.className = "swiper-slide bestseller-product";

//         const encodedId = `${product.id}-piescakes`;
//         const encodedIdPrefilled = btoa(encodedId);

//         // Prepare Swiper slides for images
//         let imagesHTML = "";
//         if (Array.isArray(product.product_images) && product.product_images.length > 0) {
//           product.product_images.forEach(img =>
//             imagesHTML += `<div class="swiper-slide"><img src="data:image/png;base64,${img}" alt="${product.name}" /></div>`
//           );
//         } else {
//           imagesHTML = `<div class="swiper-slide"><img src="default.jpg" alt="No image" /></div>`;
//         }

//         const swiperClass = `bestseller-swiper-${index}`; // unique class per product

//         const sizeButtons = product.serving_sizes.map((s, i) => `
//         <button class="size-btn" data-price="${s.price}" data-discount="${s.discount_price}" ${i === 0 ? 'class="active size-btn"' : 'class="size-btn"'}>${s.size}</button>
//       `).join("");

//       const initialPrice = product.serving_sizes?.[0]?.price || "0.00";
//       const initialDiscount = product.serving_sizes?.[0]?.discount_price || "0.00";

//       slide.innerHTML = `
//         <a href="/product/${encodedIdPrefilled}" style="text-decoration:none !important;color:inherit;">
//           <div class="product-image">
//             <div class="swiper ${swiperClass}">
//               <div class="swiper-wrapper">
//                 ${imagesHTML}
//               </div>
//             </div>
//             <span class="badge">${product.reviews.length > 50 ? "HOT" : ""}</span>
//           </div>
//           <div class="product-info">
//             <p class="category">${product.category.name}</p>
//             <h3>${product.name}</h3>
//             <div class="rating">⭐⭐⭐⭐⭐</div>
//             <div class="size-buttons">
//               ${sizeButtons}
//             </div>
//             <p class="price">
//               ₹<span class="actual-price">${parseFloat(initialPrice).toFixed(2)}</span>
//               ${parseFloat(initialDiscount) > 0 ? `<del class="discount-price">₹${parseFloat(initialDiscount).toFixed(2)}</del>` : ""}
//             </p>
//           </div>
//         </a>
//       `;

//         wrapper.appendChild(slide);

//         // Initialize Swiper for this card
//         setTimeout(() => {
//           new Swiper(`.${swiperClass}`, {
//             loop: true,
//             autoplay: { delay: 3000 },
//             pagination: false
//           });
//         }, 0);
//       });
//     })
//     .catch(err => {
//       console.error("Error loading bestsellers:", err);
//     });
// }
document.addEventListener("DOMContentLoaded", loadBestsellers);

function loadBestsellers() {
  const wrapper = document.getElementById("bestsellerWrapper");
  wrapper.innerHTML = "";

  // Insert skeletons
  for (let i = 0; i < 5; i++) {
    const skel = document.createElement("div");
    skel.className = "swiper-slide skeleton-card loading";
    skel.innerHTML = `
      <div class="skeleton-image"></div>
      <div class="skeleton-text"></div>
      <div class="skeleton-text" style="width:60%;"></div>
    `;
    wrapper.appendChild(skel);
  }

  fetch(`/api/products-list/?page=1&pageSize=10`)
    .then(res => res.json())
    .then(data => {
      if (!data.products) throw new Error("No products");
      wrapper.innerHTML = "";

      data.products.products.forEach((product, index) => {
        const slide = document.createElement("div");
        slide.className = "swiper-slide bestseller-product";

        const encodedId = `${product.id}-piescakes`;
        const encodedIdPrefilled = btoa(encodedId);

        // Prepare image slides
        let imagesHTML = "";
        if (Array.isArray(product.product_images) && product.product_images.length > 0) {
          product.product_images.forEach(img =>
            imagesHTML += `<div class="swiper-slide"><img src="data:image/png;base64,${img}" alt="${product.name}" /></div>`
          );
        } else {
          imagesHTML = `<div class="swiper-slide"><img src="default.jpg" alt="No image" /></div>`;
        }

        const swiperClass = `bestseller-swiper-${index}`;

        const sizeButtons = product.serving_sizes.map((s, i) => `
          <button class="size-btn${i === 0 ? ' active' : ''}" 
                  data-price="${s.price}" 
                  data-discount="${s.discount_price}">${s.size}</button>
        `).join("");

        const initialPrice = product.serving_sizes?.[0]?.price || "0.00";
        const initialDiscount = product.serving_sizes?.[0]?.discount_price || "0.00";

        slide.innerHTML = `
          <a href="/product/${encodedIdPrefilled}" style="text-decoration:none !important;color:inherit;">
            <div class="product-image">
              <div class="swiper ${swiperClass}">
                <div class="swiper-wrapper">
                  ${imagesHTML}
                </div>
              </div>
              <span class="badge">${product.reviews.length > 50 ? "HOT" : ""}</span>
            </div>
            <div class="product-info">
              <p class="category">${product.category.name}</p>
              <h3>${product.name}</h3>
              <div class="rating">⭐⭐⭐⭐⭐</div>
              <div class="size-buttons">${sizeButtons}</div>
              <p class="price">
                ₹<span class="actual-price">${parseFloat(initialPrice).toFixed(2)}</span>
                ${parseFloat(initialDiscount) > 0 ? `<del class="discount-price">₹${parseFloat(initialDiscount).toFixed(2)}</del>` : ""}
              </p>
            </div>
          </a>
        `;

        wrapper.appendChild(slide);

        // Initialize Swiper for this card
        setTimeout(() => {
          new Swiper(`.${swiperClass}`, {
            loop: true,
            autoplay: { delay: 3000 },
            pagination: false
          });
        }, 0);

        // Add size button click behavior
        const sizeBtns = slide.querySelectorAll(".size-btn");
        const priceEl = slide.querySelector(".actual-price");
        const discountEl = slide.querySelector(".discount-price");

        sizeBtns.forEach(btn => {
          btn.addEventListener("click", e => {
            e.preventDefault();
            sizeBtns.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            const price = parseFloat(btn.dataset.price).toFixed(2);
            const discount = parseFloat(btn.dataset.discount).toFixed(2);

            priceEl.textContent = price;
            if (discount > 0) {
              if (discountEl) {
                discountEl.textContent = `₹${discount}`;
                discountEl.style.display = "inline";
              } else {
                const newDel = document.createElement("del");
                newDel.className = "discount-price";
                newDel.textContent = `₹${discount}`;
                priceEl.parentElement.appendChild(newDel);
              }
            } else if (discountEl) {
              discountEl.style.display = "none";
            }
          });
        });
      });
    })
    .catch(err => {
      console.error("Error loading bestsellers:", err);
    });
}

    </script>
    <script>
        // Import or include Swiper JS and CSS in your page first
const swiper = new Swiper('.bestsellers-slider', {
  // Default for very small screens
  slidesPerView: 1,
  spaceBetween: 20,
  centeredSlides: true,        // Center that single slide on mobile :contentReference[oaicite:3]{index=3}
  watchOverflow: true,         // Disable navigation if not enough slides :contentReference[oaicite:4]{index=4}

  // Responsive breakpoints
  breakpoints: {
    // ≥768px – show 3 slides
    768: {
      slidesPerView: 3,
      spaceBetween: 24,
      centeredSlides: false
    },
    // ≥1200px – show 4 slides
    1200: {
      slidesPerView: 4,
      spaceBetween: 32
    }
  },

  // Navigation arrows and pagination
  navigation: {
    nextEl: '.swiper-button-next',
    prevEl: '.swiper-button-prev'
  },
  pagination: {
    el: '.swiper-pagination',
    clickable: true
  }
});

</script>
    
