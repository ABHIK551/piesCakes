<div class="container">

    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <span>Home ></span> <span class="active">Cart</span>
    </nav>

    <!-- Cart Section -->
    <section class="cart">
        <div class="cart-items">
            <table class="cart-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Item Price</th>
                        <th>Discount</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    
                    <tr>
                        <td>
                            <img src="https://s3-alpha-sig.figma.com/img/a9ef/cf1b/07b1fafcc9d898239ef020f47f3bcd90?Expires=1743379200&Key-Pair-Id=APKAQ4GOSFWCW27IBOMQ&Signature=T4ZBQ7hli87o-o83RoWOunmEtgTXA5y4cIqoPwRHDL2h~waEDFTonkqhYMkGbifmH5wrTTFt8Uo7DOSPr7TQu6gS6NkVaHB7gFrFg7YAchnAXr~JQLfTJDKGOkWWKojJw7Gt~1GfQAaoAyICEwmqEreDvy~tMW5eUYOn2cYArr3XNe4Fk5FqU8R9kHn4QaQ-~r~y857YlQ4srqi6B7r3kAQ2DTvVnRtGpQ5DuOhat~3RJUa1n-7JwkE3Burjcf2J7Zy7mwYnKWdy72OlMqJPTSAGiRfAxnODTs9rPjH5HJB-T8E--mkNFqwI2ief23wcQFCKB4l9Is4scRgfntnmFQ__" alt="Red Velvet" class="product-img">
                            <span>Red Velvet</span>
                        </td>
                        <td>₹700.00</td>
                        <td class="quantity">
                            <button class="qty-btn">-</button>
                            <span>1</span>
                            <button class="qty-btn">+</button>
                        </td>
                        <td>₹700</td>
                        <td><button class="remove"><i class="fas fa-trash"></i></button></td>
                    </tr>
                    <tr>
                        <td>
                            <img src="https://s3-alpha-sig.figma.com/img/45a5/b7c7/495c436c36424bfee5a0384fa68331fa?Expires=1743379200&Key-Pair-Id=APKAQ4GOSFWCW27IBOMQ&Signature=qdDBiU8FClumOXSW7aRdSkE3vMcXBwknkRAm5AF0kF9SbtyxoVI5fVW01A03M7mBBPYeXYSAeRGgA5GGl69YGqX14DgA0LjYU-uJ790XtPrjX6ljncUltu6oPys4xjk0O8CVXXYcLbvR0NqElMDuNH4lhS85jYXjsCwLfPC5G5DQWkw8Wqvz5kN2MtWcXQwmiiwqYfnZ3eXGEOxF5BLsfo6g5lU2PLItEF7g-0pdq9yImEnR2MMZY4ZDRPrPpVg6Pc0Tubx53tcY9P3RjU2gJVV6vvC6eLBJ18eA1IMyArozke9BqTBhXJ31yH0dbptwLTUfcrfVuiKcXouVz-IIzA__" alt="BLUEBERRY CHEESE CAKE" class="product-img">
                            <span>BLUEBERRY CHEESE CAKE</span>
                        </td>
                        <td>₹200.00</td>
                        <td class="quantity">
                            <button class="qty-btn">-</button>
                            <span>1</span>
                            <button class="qty-btn">+</button>
                        </td>
                        <td>₹200</td>
                        <td><button class="remove"><i class="fas fa-trash"></i></button></td>
                    </tr>
                    <tr>
                        <td>
                            <img src="https://s3-alpha-sig.figma.com/img/0406/0f5e/2352a86563a173ec4d68f918cc3d72ff?Expires=1743379200&Key-Pair-Id=APKAQ4GOSFWCW27IBOMQ&Signature=Vgd54yRnBTopaZFrVWD153rhTK6VUkmfw1t5~tuOrXcvBc92Ny8X-uVw~XD3P1Sj5cFOhADStK15g3KCSl~XZdAhcy-1d9eSujQvfbo0Lh8QCORQZQ2F2hudRzvifSSZ0zYjUDrVbUYisj0EX5Jjj1MvnLldcB6HyKUMNlxn7ZB~urqKQEaFkLb1uUU7yom8XtYELfwryodi-JVEqczFExdNiGG0KLeECroynepgTp2BlX8e-8CvVJqm1ppHJb6liDEqV1P70Q3Fhwyyt2nFM-UFlrvP3asLOiZ704spj1J45FGt3hFDWzaZs4SYLq3gWelhAYgWcpaRvdPcgSqNiQ__" alt="MOTICHOOR RABDI MOUSSE CAKE" class="product-img">
                            <span>MOTICHOOR RABDI MOUSSE CAKE</span>
                        </td>
                        <td>₹65.00</td>
                        <td class="quantity">
                            <button class="qty-btn">-</button>
                            <span>1</span>
                            <button class="qty-btn">+</button>
                        </td>
                        <td>₹65</td>
                        <td><button class="remove"><i class="fas fa-trash"></i></button></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="shop-more">
                <a href="/" style="float: left;margin: auto 0%;">Continue Shopping</a>
                <button class="checkout" style="width: 200px;float: right;">Check Out</button>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary">
            <h2>Summary</h2>
            <p>Estimate Shipping</p>
            <form>
                <label>City *</label>
                <select>
                    <option value="">Select City</option>
                    <option>Ranchi</option>
                    <option>Jamshedpur</option>
                    <option>Dhanbad</option>
                    <option>Bokaro</option>
                    <option>Hazaribagh</option>
                    <option>Deoghar</option>
                    <option>Giridih</option>
                    <option>Ramgarh</option>
                    <option>Palamu</option>
                    <option>Chaibasa</option>
                </select>
            
                <label>Location</label>
                <select>
                    <option>Choose Location</option>
                </select>
            
                <label>Zip/Postal Code</label>
                <input type="text" placeholder="Zip/Postal Code">
            </form>
            
            <div class="cost">
                <p>Sub-Total: <span>₹965.00</span></p>
                <p>Delivery Charges: <span>₹0.00</span></p>
                <p>Coupon Discount: <a href="#">Apply Discount</a></p>
            </div>
            <h3>Total Amount: ₹965.00</h3>
        </div>
    </section>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const token = sessionStorage.getItem("auth_token");
    
        if (!token) {
            redirectToLogin();  // Token is missing
            return;
        }

        function redirectToLogin() {
            alert("Your session has expired. Please log in again.");
            window.location.href = "/login"; // Replace with your actual login URL
        }
    
        const userId = sessionStorage.getItem("user_id");
        const cartTableBody = document.querySelector(".cart-table tbody");
    
        fetch(`/api/view-cart/${userId}/`, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        })
        .then(response => {
            if (response.status === 401) {
                redirectToLogin();
                return;
            }
            return response.json();  // ✅ RETURN THIS
        })
        .then(data => {
            if (!data || !data.products || data.products.length === 0) {
                cartTableBody.innerHTML = `<tr><td colspan="6">Your cart is empty.</td></tr>`;
                sessionStorage.setItem("cart_count", "0");
                return;
            }
    
            let totalAmount = 0;
            cartTableBody.innerHTML = "";
    
            data.products.forEach(product => {
                const price = parseFloat(product.price);
                const discount_price = parseFloat(product.discount_price);
                const quantity = 1;
                const total = price * quantity;
                totalAmount += total;
    
                const imageSrc = product.product_images_base64_output
                    ? `data:image/jpeg;base64,${product.product_images_base64_output}`
                    : 'default.jpg';
    
                const rowHTML = `
                    <tr>
                        <td>
                            <img src="${imageSrc}" alt="${product.name}" class="product-img">
                            <span>${product.name}</span>
                        </td>
                        <td>₹${price.toFixed(2)}</td>
                        <td>₹${discount_price.toFixed(2)}</td>
                        <td class="quantity">
                            <button class="qty-btn minusQtyBTN">-</button>
                            <span class="quantityControl">${quantity}</span>
                            <button class="qty-btn addQtyBTN">+</button>
                        </td>
                        <td>₹${total.toFixed(2)}</td>
                        <td><button class="remove"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
    
                cartTableBody.insertAdjacentHTML("beforeend", rowHTML);
            });
    
            sessionStorage.setItem("cart_count", data.products.length.toString());
    
            document.querySelector(".cost span").textContent = `₹${totalAmount.toFixed(2)}`;
            document.querySelector("h3").textContent = `Total Amount: ₹${totalAmount.toFixed(2)}`;
    
            attachQuantityHandlers();
            updateTotalAmount();
        })
        .catch(error => {
            console.error("Error loading cart:", error);
            cartTableBody.innerHTML = `<tr><td colspan="6">Failed to load cart items.</td></tr>`;
        });
    });
    </script>
    
<script>
function attachQuantityHandlers() {
  document.querySelectorAll(".cart-table tbody tr").forEach(row => {
    const minusBtn     = row.querySelector(".minusQtyBTN");
    const plusBtn      = row.querySelector(".addQtyBTN");
    const quantitySpan = row.querySelector(".quantityControl");
    const priceTd      = row.children[1];  // Item Price
    const totalTd      = row.children[4];  // Total

    if (!minusBtn || !plusBtn || !quantitySpan || !priceTd || !totalTd) return;

    const unitPrice = parseFloat(priceTd.textContent.replace("₹", ""));
    let quantity   = parseInt(quantitySpan.textContent);

    plusBtn.addEventListener("click", () => {
      quantity++;
      quantitySpan.textContent = quantity;
      totalTd.textContent      = `₹${(unitPrice * quantity).toFixed(2)}`;
      updateTotalAmount();
    });

    minusBtn.addEventListener("click", () => {
      if (quantity > 1) {
        quantity--;
        quantitySpan.textContent = quantity;
        totalTd.textContent      = `₹${(unitPrice * quantity).toFixed(2)}`;
        updateTotalAmount();
      }
    });
  });
}

function updateTotalAmount() {
    let total = 0;
    document.querySelectorAll(".cart-table tbody tr").forEach(row => {
        const totalCell = row.children[5];
        if (!totalCell) return;

        const totalText = totalCell.textContent.replace("₹", "").trim();
        const totalValue = parseFloat(totalText);
        if (!isNaN(totalValue)) {
            total += totalValue;
        }
    });

    // Update subtotal and total amount
    const subtotalEl = document.querySelector(".cost span");
    const totalAmountEl = document.querySelector(".summary h3");

    if (subtotalEl) {
        subtotalEl.textContent = `₹${total.toFixed(2)}`;
    }
    if (totalAmountEl) {
        totalAmountEl.textContent = `Total Amount: ₹${total.toFixed(2)}`;
    }
}


document.addEventListener("DOMContentLoaded", () => {
    attachQuantityHandlers();
});

</script>
    