{% extends "frontend/base.html" %}
{% block content %}
{% include "frontend/nav.html" %}
<style>
#category-filters ul {
    list-style: none !important;
    padding-left: 0 !important;
    margin: 0 !important;
}

#category-filters li {
    margin-bottom: 10px !important;
    /* min-width: 100% !important; */
}

#category-filters label {
    display: block !important;
    margin-bottom: 4px !important;
    cursor: pointer !important;
    display: flex;
    align-items: center;
}

    @media screen and (max-width: 468px) {
        .categories-product{
            width: 100%;
            padding: 0px;
        }
        .categories-product .product-section .product-card{
            min-width: 320px;
        }
        .categories-product .product-section .product-card .product-info h3{
            width: 100%;
            text-align: left;
        }
        .categories-product .product-section .product-card .product-info h4{
            width: 100%;
            text-align: left;
        }
        .categories-product .product-section .product-card .product-info .rating{
            width: 100%;
            text-align: left;
        }
        #filter-sidebar-main {
    position: fixed;
    top: 0;
    left: 0;
    display: none;
    height: 100vh;
    z-index: 1999;
    background: white;
    width: 220px;
    }
    }
</style>
<div class="margin-bottom:30px;" style="float: right;margin-top: 20px;margin-right: 20px;font-size: 20px;">
<b>
    <div class="mobile-filter-toggle" id="mobile-filter-toggle" onclick="toggleFilter()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" y1="21" x2="4" y2="14"></line>
            <line x1="4" y1="10" x2="4" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12" y2="3"></line>
            <line x1="20" y1="21" x2="20" y2="16"></line>
            <line x1="20" y1="12" x2="20" y2="3"></line>
          </svg>
    </div>

</b>
</div>

<section class="categories-product" style="width: 100%;">
    <div class="filter-sidebar" id="filter-sidebar-main">
        <!-- CATEGORY FILTER -->
        <div class="filter-section" id="category-filters">
            <h3>Category</h3>
            <ul id="category-list">
                <!-- Categories will be populated here -->
            </ul>
        </div>

        <!-- SUBCATEGORY SECTION -->
        <div class="filter-section" id="subcategory-filters">
            <h3>Subcategories</h3>
            <ul id="subcategory-list">
                <!-- Subcategories will appear here based on selected category -->
            </ul>
        </div>


        <!-- WEIGHT FILTER -->
        <div class="filter-section" id="weight-filters">
            <h3>Serving Size</h3>
            <ul id="weight-filter-list">
                <li><input type="checkbox" value="1 Slice"> 1 Slice</li>
                <li><input type="checkbox" value="2 Slice"> 2 Slice</li>
                <li><input type="checkbox" value="200g"> 200g</li>
                <li><input type="checkbox" value="250g"> 250g</li>
                <li><input type="checkbox" value="500g"> 500g</li>
                <li><input type="checkbox" value="1000g"> 1000g</li>
                <li><input type="checkbox" value="Combo"> Combo</li>
            </ul>
        </div>

        <!-- PRICE FILTER -->
        <div class="filter-section">
            <label for="priceRange">Price: ₹<span id="priceValue">0</span></label>
            <input type="range" min="0" max="20000" value="350" id="price-range">
        </div>

        <!-- TAGS -->
        <div class="filter-section">
            <h3>Tags</h3>
            <div class="tags">
                <span>Cakes</span>
                <span>Cookies</span>
                <span>Pastries</span>
                <span>Cupcakes</span>
                <span>Brownies</span>
                <span>Breads</span>
                <span>Muffins</span>
                <span>Desserts</span>
                <span>Custom Cakes</span>
                <span>Eggless & Vegan</span>
            </div>
        </div>
    </div>

    <!-- PRODUCTS -->
    <div class="product-section">
        <div class="product-card">
        </div>
    </div>
</section>
<!-- <script>
    document.addEventListener("DOMContentLoaded", () => {
        const apiUrl = "/api/products-list/?pageSize=10";
        let allProducts = [];
    
        // Elements
        const productSection = document.querySelector(".product-section");
        const categoryFilterContainer = document.querySelector("#category-filters ul");
        const weightInputs = document.querySelectorAll("#weight-filters input[type='checkbox']");
        const priceRange = document.querySelector("#price-range");
        const tagSpans = document.querySelectorAll(".tags span");
    
        // Fetch products
        fetch(apiUrl)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    allProducts = data.products.products;
    
                    // Step 1: Build unique category filters
                    const uniqueCategories = new Set();
                    allProducts.forEach(product => {
                        if (product.category && product.category.name) {
                            uniqueCategories.add(product.category.name);
                        }
                    });
    
                    // Step 2: Render category checkboxes dynamically
                    categoryFilterContainer.innerHTML = "";
                    uniqueCategories.forEach(categoryName => {
                        const li = document.createElement("li");
                        li.innerHTML = `
                            <input type="checkbox" value="${categoryName}"> ${categoryName}
                        `;
                        categoryFilterContainer.appendChild(li);
                    });
    
                    // Step 3: Add event listeners to new checkboxes
                    const categoryInputs = categoryFilterContainer.querySelectorAll("input[type='checkbox']");
                    categoryInputs.forEach(input => {
                        input.addEventListener("change", applyFilters);
                    });
    
                    renderProducts(allProducts);
                }
            });
    
        // Render products
        function renderProducts(products) {
            productSection.innerHTML = "";
    
            if (!products.length) {
                productSection.innerHTML = "<p>No products match the selected filters.</p>";
                return;
            }
    
            products.forEach(product => {
                const imgSrc = product.product_images?.startsWith("/") 
                    ? `data:image/jpeg;base64,${product.product_images}`
                    : product.product_images || "default.jpg";

                    let product_ids = [];
                    product_ids.push(product.id);  // or whatever ID you're pushing
                    let user_id = sessionStorage.getItem('user_id');

                    sendData = {
                        "productIds": product_ids,
                        "userId": user_id
                    }

                    const json_data = JSON.stringify(sendData);
                    const encoded_data = btoa(unescape(encodeURIComponent(json_data)));
                    const encodedId = btoa(`${product.id}-piescakes`);
                    const isBase64 = imgSrc.startsWith('data:image');
                    const imgSrcFinal = isBase64 ? imgSrc : `data:image/jpeg;base64,${imgSrc}`;
                const productHTML = `
                    <div class="product-card">
                        <a href="/product/${encodedId}">
                            <div class="product-image">
                            <img src="${imgSrcFinal}" alt="${product.name}" loading="lazy">
                            </div>
                        </a>
                            <div class="product-info">
                                <h4 style="color: grey; margin: 0;">${product.category.name}</h4>
                                <h3 style="margin: 5px 0;">${product.name}</h3>
                                <p class="price" style="margin: 5px 0;">
                                    <span class="current-price" style="color: orange; font-weight: bold;">
                                        ₹${product.discount_price ? (product.price - product.discount_price).toFixed(2) : product.price.toFixed(2)}
                                    </span>
                                    ${product.discount_price ? `<span class="old-price" style="text-decoration: line-through; color: grey; margin-left: 8px;">₹${product.price.toFixed(2)}</span>` : ''}
                                </p>
                                <div class="rating" style="color: #FFD700; font-size: 1.2em; margin-bottom: 10px;width:100%">
                                    ★★★★★
                                </div>
                                <div class="buttons" style="display: flex; gap: 10px;">
                                    <button class="add-to-cart" style="background-color: orange; color: white; padding: 8px 12px; border: none; border-radius: 5px; font-weight: bold;" onclick="addToCart('${encoded_data}')">ADD TO CART</button>
                                    <button class="buy-now" style="background-color: #4a3f3f; color: white; padding: 8px 12px; border: none; border-radius: 5px; font-weight: bold;">BUY NOW</button>
                                </div>
                            </div>
                    </div>`;
    
                productSection.insertAdjacentHTML("beforeend", productHTML);
            });
        }
    
        // Filter logic
        function applyFilters() {
            const categoryInputs = document.querySelectorAll("#category-filters input[type='checkbox']");
            console.log("categoryInputs", [...categoryInputs]);
            const selectedCategories = [...categoryInputs].filter(i => i.checked).map(i => i.value);
            const selectedWeights = [...weightInputs].filter(i => i.checked).map(i => i.value.toLowerCase());
            const selectedTags = [...tagSpans].filter(span => span.classList.contains("active")).map(span => span.textContent.trim().toLowerCase());
            const maxPrice = parseFloat(priceRange.value);
    
            const filtered = allProducts.filter(p => {
                const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(p.category.name);
                const weightMatch = selectedWeights.length === 0 || selectedWeights.includes(p.cake_size?.toLowerCase());
                const priceMatch = parseFloat(p.price) <= maxPrice;
                const tagsMatch = selectedTags.length === 0 || selectedTags.some(tag => p.tags?.toLowerCase().includes(tag));

                return categoryMatch && weightMatch && priceMatch && tagsMatch;
            });
    
            renderProducts(filtered);
        }
    
        priceRange.addEventListener("input", applyFilters);
    
        tagSpans.forEach(span => {
            span.style.cursor = "pointer";
            span.addEventListener("click", () => {
                span.classList.toggle("active");
                applyFilters();
            });
        });
    });

    function addToCart(encodedData) {
        // Decode the base64-encoded data
        const decodedData = JSON.parse(atob(encodedData));
        const productIds = decodedData.productIds;
        const userId = decodedData.userId;

        // Check if user is logged in
        if (!userId) {
            showToast("Please login to add items to the cart", "danger");
            return;
        }

        // Build cart items with default quantity = 1
        const cartItems = productIds.map(productId => ({
            product: productId,
            quantity: 1
        }));

        const data = {
            userId: userId,
            cartItems: cartItems
        };

        // Send a POST request to the API to add products to the cart
        fetch('/api/add-to-cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data && !data.error) {
                showToast("Products added to cart successfully!", "success");
            } else {
                showToast("Failed to add products to cart.", "danger");
            }
        })
        .catch(error => {
            console.error("Error:", error);
            showToast("An error occurred while adding to cart.", "danger");
        });
    }

    </script>
    -->
   

    <!-- <script>
        document.addEventListener("DOMContentLoaded", () => {
            const apiUrl = "/api/products-list/?pageSize=10";
            let allProducts = [];
    
            // Elements
            const productSection = document.querySelector(".product-section");
            const categoryFilterContainer = document.querySelector("#category-filters ul");
            const categoryList = document.getElementById("category-list");
            const subcategoryList = document.getElementById("subcategory-list");s
            const weightInputs = document.querySelectorAll("#weight-filters input[type='checkbox']");
            const priceRange = document.querySelector("#price-range");
            const tagSpans = document.querySelectorAll(".tags span");
    
            // Fetch products
            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        allProducts = data.products.products;
    
                        // Step 1: Build category-subcategory map
                        const categoryMap = new Map();
    
                        allProducts.forEach(product => {
                            if (product.category) {
                                const category = product.category.parent ? product.category.parent.name : product.category.name;
                                const subcategory = product.category.parent ? product.category.name : null;
    
                                if (!categoryMap.has(category)) {
                                    categoryMap.set(category, new Set());
                                }
    
                                if (subcategory) {
                                    categoryMap.get(category).add(subcategory);
                                }
                            }
                        });
    
                        categoryFilterContainer.innerHTML = "";

                        categoryMap.forEach((subcategories, categoryName) => {
                            const categoryLi = document.createElement("li");

                            // Main category checkbox wrapper
                            const categoryLabel = document.createElement("label");
                            categoryLabel.style.fontWeight = "bold";
                            categoryLabel.style.display = "flex";
                            categoryLabel.style.flexDirection = "row";
                            categoryLabel.style.alignItems = "flex-start";
                            categoryLabel.style.gap = "6px";
                            categoryLabel.innerHTML = `
                                <input type="checkbox" class="category-filter" value="${categoryName}">
                                <span style="display: inline-block; white-space: normal; word-break: break-word;">${categoryName}</span>
                            `;
                            categoryLi.appendChild(categoryLabel);

                            // Subcategories
                            if (subcategories.size > 0) {
                                const subUl = document.createElement("ul");
                                subUl.style.listStyle = "none";
                                subUl.style.paddingLeft = "16px";

                                subcategories.forEach(subName => {
                                    const subLi = document.createElement("li");

                                    const subLabel = document.createElement("label");
                                    subLabel.style.display = "flex";
                                    subLabel.style.flexDirection = "row";
                                    subLabel.style.alignItems = "flex-start";
                                    subLabel.style.gap = "6px";
                                    subLabel.innerHTML = `
                                        <input type="checkbox" class="subcategory-filter" value="${subName}" data-category="${categoryName}">
                                        <span style="display: inline-block; white-space: normal; word-break: break-word;">${subName}</span>
                                    `;
                                    subLi.appendChild(subLabel);
                                    subUl.appendChild(subLi);
                                });

                                categoryLi.appendChild(subUl);
                            }

                            categoryFilterContainer.appendChild(categoryLi);
                        });



    
                        // Step 3: Add event listeners to new checkboxes
                        document.querySelectorAll(".category-filter, .subcategory-filter").forEach(input => {
                            input.addEventListener("change", applyFilters);
                        });
    
                        renderProducts(allProducts);
                    }
                });
    
            // Render products
            function renderProducts(products) {
                productSection.innerHTML = "";
    
                if (!products.length) {
                    productSection.innerHTML = "<p>No products match the selected filters.</p>";
                    return;
                }
    
                products.forEach(product => {
                    const imgSrc = product.product_images?.startsWith("/") 
                        ? `data:image/jpeg;base64,${product.product_images}`
                        : product.product_images || "default.jpg";
    
                    let product_ids = [];
                    product_ids.push(product.id);
                    let user_id = sessionStorage.getItem('user_id');
    
                    const sendData = {
                        "productIds": product_ids,
                        "userId": user_id
                    };
    
                    const json_data = JSON.stringify(sendData);
                    const encoded_data = btoa(unescape(encodeURIComponent(json_data)));
                    const encodedId = btoa(`${product.id}-piescakes`);
                    const isBase64 = imgSrc.startsWith('data:image');
                    const imgSrcFinal = isBase64 ? imgSrc : `data:image/jpeg;base64,${imgSrc}`;
    
                    const productHTML = `
                        <div class="product-card">
                            <a href="/product/${encodedId}">
                                <div class="product-image">
                                    <img src="${imgSrcFinal}" alt="${product.name}" loading="lazy">
                                </div>
                            </a>
                            <div class="product-info">
                                <h4 style="color: grey; margin: 0;">${product.category.name}</h4>
                                <h3 style="margin: 5px 0;">${product.name}</h3>
                                <p class="price" style="margin: 5px 0;">
                                    <span class="current-price" style="color: orange; font-weight: bold;">
                                        ₹${product.discount_price ? (product.price - product.discount_price).toFixed(2) : product.price.toFixed(2)}
                                    </span>
                                    ${product.discount_price ? `<span class="old-price" style="text-decoration: line-through; color: grey; margin-left: 8px;">₹${product.price.toFixed(2)}</span>` : ''}
                                </p>
                                <div class="rating" style="color: #FFD700; font-size: 1.2em; margin-bottom: 10px;width:100%">
                                    ★★★★★
                                </div>
                                <div class="buttons" style="display: flex; gap: 10px;">
                                    <button class="add-to-cart" style="background-color: orange; color: white; padding: 8px 12px; border: none; border-radius: 5px; font-weight: bold;" onclick="addToCart('${encoded_data}')">ADD TO CART</button>
                                    <button class="buy-now" style="background-color: #4a3f3f; color: white; padding: 8px 12px; border: none; border-radius: 5px; font-weight: bold;">BUY NOW</button>
                                </div>
                            </div>
                        </div>`;
    
                    productSection.insertAdjacentHTML("beforeend", productHTML);
                });
            }
    
            // Filter logic
            function applyFilters() {
                const selectedCategories = [...document.querySelectorAll(".category-filter:checked")].map(i => i.value);
                const selectedSubCategories = [...document.querySelectorAll(".subcategory-filter:checked")].map(i => i.value);
                const selectedWeights = [...weightInputs].filter(i => i.checked).map(i => i.value.toLowerCase());
                const selectedTags = [...tagSpans].filter(span => span.classList.contains("active")).map(span => span.textContent.trim().toLowerCase());
                const maxPrice = parseFloat(priceRange.value);
    
                const filtered = allProducts.filter(p => {
                    const catName = p.category?.parent?.name || p.category?.name;
                    const subCatName = p.category?.parent ? p.category?.name : null;
    
                    const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(catName);
                    const subCategoryMatch = selectedSubCategories.length === 0 || (subCatName && selectedSubCategories.includes(subCatName));
                    const weightMatch = selectedWeights.length === 0 || selectedWeights.includes(p.cake_size?.toLowerCase());
                    const priceMatch = parseFloat(p.price) <= maxPrice;
                    const tagsMatch = selectedTags.length === 0 || selectedTags.some(tag => p.tags?.toLowerCase().includes(tag));
    
                    return categoryMatch && subCategoryMatch && weightMatch && priceMatch && tagsMatch;
                });
    
                renderProducts(filtered);
            }
    
            priceRange.addEventListener("input", applyFilters);
    
            tagSpans.forEach(span => {
                span.style.cursor = "pointer";
                span.addEventListener("click", () => {
                    span.classList.toggle("active");
                    applyFilters();
                });
            });
        });
    
        function addToCart(encodedData) {
            const decodedData = JSON.parse(atob(encodedData));
            const productIds = decodedData.productIds;
            const userId = decodedData.userId;
    
            if (!userId) {
                showToast("Please login to add items to the cart", "danger");
                return;
            }
    
            const cartItems = productIds.map(productId => ({
                product: productId,
                quantity: 1
            }));
    
            const data = {
                userId: userId,
                cartItems: cartItems
            };
    
            fetch('/api/add-to-cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data && !data.error) {
                    showToast("Products added to cart successfully!", "success");
                } else {
                    showToast("Failed to add products to cart.", "danger");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                showToast("An error occurred while adding to cart.", "danger");
            });
        }
    </script>
     -->
<!-- 
     <script>
        document.addEventListener("DOMContentLoaded", () => {
            const apiUrl = "/api/products-list/?pageSize=10";
            let allProducts = [];
    
            // Elements
            const productSection = document.querySelector(".product-section");
            const categoryList = document.getElementById("category-list");
            const subcategoryList = document.getElementById("subcategory-list");
            const weightInputs = document.querySelectorAll("#weight-filters input[type='checkbox']");
            const priceRange = document.querySelector("#price-range");
            const tagSpans = document.querySelectorAll(".tags span");
    
            // Fetch products
            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        allProducts = data.products.products;
    
                        // Step 1: Build category-subcategory map
                        const categoryMap = new Map();
                        const weightSet = new Set();
    
                        allProducts.forEach(product => {
                            if (product.category) {
                                const category = product.category.parent ? product.category.parent.name : product.category.name;
                                const subcategory = product.category.parent ? product.category.name : null;
                                const servingSize = product.serving_size ? product.serving_size : null;
                                if (!categoryMap.has(category)) {
                                    categoryMap.set(category, new Set());
                                }

                                if (servingSize) {
                                    weightSet.add(servingSize, new Set());
                                }
    
                                if (subcategory) {
                                    categoryMap.get(category).add(subcategory);
                                }
                            }
                        });
    
                        populateCategories(categoryMap);
                        renderProducts(allProducts);
                    }
                });
    
            // Populate category list
            function populateCategories(categoryMap) {
                categoryList.innerHTML = "";
    
                categoryMap.forEach((_, categoryName) => {
                    const li = document.createElement("li");
                    const label = document.createElement("label");
                    label.innerHTML = `
                        <input type="checkbox" class="category-filter" value="${categoryName}">
                        <span>${categoryName}</span>
                    `;
                    li.appendChild(label);
                    categoryList.appendChild(li);
                });
    
                document.querySelectorAll(".category-filter").forEach(checkbox => {
                    checkbox.addEventListener("change", () => updateSubcategories(categoryMap));
                });
            }

            const weightFilterList = document.getElementById("weight-filter-list");
            weightFilterList.innerHTML = "";

            weightSet.forEach(size => {
                const li = document.createElement("li");
                const label = document.createElement("label");
                label.style.display = "flex";
                label.style.alignItems = "center";
                label.style.gap = "6px";
                label.innerHTML = `
                    <input type="checkbox" value="${size}" class="weight-filter">
                    <span>${size}</span>
                `;
                li.appendChild(label);
                weightFilterList.appendChild(li);
            });
    
            // Update subcategory list based on selected categories
            function updateSubcategories(categoryMap) {
                subcategoryList.innerHTML = "";
    
                document.querySelectorAll(".category-filter:checked").forEach(categoryCheckbox => {
                    const category = categoryCheckbox.value;
                    const subcategories = categoryMap.get(category);
    
                    if (subcategories) {
                        subcategories.forEach(sub => {
                            const li = document.createElement("li");
                            const label = document.createElement("label");
                            label.innerHTML = `
                                <input type="checkbox" class="subcategory-filter" value="${sub}" data-category="${category}">
                                <span>${sub}</span>
                            `;
                            li.appendChild(label);
                            subcategoryList.appendChild(li);
                        });
                    }
                });
    
                document.querySelectorAll(".subcategory-filter").forEach(input => {
                    input.addEventListener("change", applyFilters);
                });
    
                applyFilters();
            }
    
            // Render products
            function renderProducts(products) {
                productSection.innerHTML = "";
    
                if (!products.length) {
                    productSection.innerHTML = "<p>No products match the selected filters.</p>";
                    return;
                }
    
                products.forEach(product => {
                    const imgSrc = product.product_images?.startsWith("/") 
                        ? `data:image/jpeg;base64,${product.product_images}`
                        : product.product_images || "default.jpg";
    
                    let product_ids = [];
                    product_ids.push(product.id);
                    let user_id = sessionStorage.getItem('user_id');
    
                    const sendData = {
                        "productIds": product_ids,
                        "userId": user_id
                    };
    
                    const json_data = JSON.stringify(sendData);
                    const encoded_data = btoa(unescape(encodeURIComponent(json_data)));
                    const encodedId = btoa(`${product.id}-piescakes`);
                    const isBase64 = imgSrc.startsWith('data:image');
                    const imgSrcFinal = isBase64 ? imgSrc : `data:image/jpeg;base64,${imgSrc}`;
    
                    const productHTML = `
                        <div class="product-card">
                            <a href="/product/${encodedId}">
                                <div class="product-image">
                                    <img src="${imgSrcFinal}" alt="${product.name}" loading="lazy">
                                </div>
                            </a>
                            <div class="product-info">
                                <h4 style="color: grey; margin: 0;">${product.category.name}</h4>
                                <h3 style="margin: 5px 0;">${product.name}</h3>
                                <p class="price" style="margin: 5px 0;">
                                    <span class="current-price" style="color: orange; font-weight: bold;">
                                        ₹${product.discount_price ? (product.price - product.discount_price).toFixed(2) : product.price.toFixed(2)}
                                    </span>
                                    ${product.discount_price ? `<span class="old-price" style="text-decoration: line-through; color: grey; margin-left: 8px;">₹${product.price.toFixed(2)}</span>` : ''}
                                </p>
                                <div class="rating" style="color: #FFD700; font-size: 1.2em; margin-bottom: 10px;width:100%">
                                    ★★★★★
                                </div>
                                <div class="buttons" style="display: flex; gap: 10px;">
                                    <button class="add-to-cart" style="background-color: orange; color: white; padding: 8px 12px; border: none; border-radius: 5px; font-weight: bold;" onclick="addToCart('${encoded_data}')">ADD TO CART</button>
                                    <button class="buy-now" style="background-color: #4a3f3f; color: white; padding: 8px 12px; border: none; border-radius: 5px; font-weight: bold;">BUY NOW</button>
                                </div>
                            </div>
                        </div>`;
    
                    productSection.insertAdjacentHTML("beforeend", productHTML);
                });
            }
    
            // Filter logic
            function applyFilters() {
                const selectedCategories = [...document.querySelectorAll(".category-filter:checked")].map(i => i.value);
                const selectedSubCategories = [...document.querySelectorAll(".subcategory-filter:checked")].map(i => i.value);
                const selectedWeights = [...weightInputs].filter(i => i.checked).map(i => i.value.toLowerCase());
                const selectedTags = [...tagSpans].filter(span => span.classList.contains("active")).map(span => span.textContent.trim().toLowerCase());
                const maxPrice = parseFloat(priceRange.value);
    
                const filtered = allProducts.filter(p => {
                    const catName = p.category?.parent?.name || p.category?.name;
                    const subCatName = p.category?.parent ? p.category?.name : null;
    
                    const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(catName);
                    const subCategoryMatch = selectedSubCategories.length === 0 || (subCatName && selectedSubCategories.includes(subCatName));
                    const weightMatch = selectedWeights.length === 0 || selectedWeights.includes(p.cake_size?.toLowerCase());
                    const priceMatch = parseFloat(p.price) <= maxPrice;
                    const tagsMatch = selectedTags.length === 0 || selectedTags.some(tag => p.tags?.toLowerCase().includes(tag));
    
                    return categoryMatch && subCategoryMatch && weightMatch && priceMatch && tagsMatch;
                });
    
                renderProducts(filtered);
            }
    
            priceRange.addEventListener("input", applyFilters);
    
            tagSpans.forEach(span => {
                span.style.cursor = "pointer";
                span.addEventListener("click", () => {
                    span.classList.toggle("active");
                    applyFilters();
                });
            });
        });
    
        function addToCart(encodedData) {
            const decodedData = JSON.parse(atob(encodedData));
            const productIds = decodedData.productIds;
            const userId = decodedData.userId;
    
            if (!userId) {
                showToast("Please login to add items to the cart", "danger");
                return;
            }
    
            const cartItems = productIds.map(productId => ({
                product: productId,
                quantity: 1
            }));
    
            const data = {
                userId: userId,
                cartItems: cartItems
            };
    
            fetch('/api/add-to-cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data && !data.error) {
                    showToast("Products added to cart successfully!", "success");
                } else {
                    showToast("Failed to add products to cart.", "danger");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                showToast("An error occurred while adding to cart.", "danger");
            });
        }
    </script>
 -->


 <script>
    document.addEventListener("DOMContentLoaded", () => {
      const apiUrl = "/api/products-list/?pageSize=10";
      let allProducts = [];
  
      // Elements
      const productSection = document.querySelector(".product-section");
      const categoryList = document.getElementById("category-list");
      const subcategoryList = document.getElementById("subcategory-list");
      const weightFilterList = document.getElementById("weight-filter-list");
      const priceRange = document.querySelector("#price-range");
      const tagSpans = document.querySelectorAll(".tags span");
  
      // Fetch products
      fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
          if (!data.success) return;
          allProducts = data.products.products;
  
          // Build category–subcategory map and weight set
          const categoryMap = new Map();
          const weightSet = new Set();
  
          allProducts.forEach(product => {
            const serving = product.serving_size?.toLowerCase().trim();
            if (serving) weightSet.add(serving);
  
            if (!product.category) return;
            const parentName = product.category.parent ? product.category.parent.name : null;
            const categoryName = parentName || product.category.name;
            const subName = parentName ? product.category.name : null;
  
            if (!categoryMap.has(categoryName)) {
              categoryMap.set(categoryName, new Set());
            }
            if (subName) categoryMap.get(categoryName).add(subName);
          });
  
          // Populate filters
          populateCategories(categoryMap);
          populateWeights(weightSet);
          renderProducts(allProducts);
        });
  
      // Populate categories and bind submenu update
      function populateCategories(categoryMap) {
        categoryList.innerHTML = "";
        categoryMap.forEach((subs, name) => {
          const li = document.createElement("li");
          const lbl = document.createElement("label");
          lbl.innerHTML = `<input type='checkbox' class='category-filter' value='${name}'/> <span>${name}</span>`;
          li.appendChild(lbl);
          categoryList.appendChild(li);
        });
        document.querySelectorAll(".category-filter").forEach(cb =>
          cb.addEventListener("change", () => updateSubcategories(categoryMap))
        );
      }
  
      // Populate weight filters
      function populateWeights(weightSet) {
        weightFilterList.innerHTML = "";
        weightSet.forEach(size => {
          const li = document.createElement("li");
          const lbl = document.createElement("label");
          lbl.style.display = "flex";
          lbl.style.alignItems = "center";
          lbl.style.gap = "6px";
          lbl.innerHTML = `<input type='checkbox' class='weight-filter' value='${size}'/> <span>${size}</span>`;
          li.appendChild(lbl);
          weightFilterList.appendChild(li);
        });
        document.querySelectorAll(".weight-filter").forEach(cb =>
          cb.addEventListener("change", applyFilters)
        );
      }
  
      // Update subcategories when categories change
      function updateSubcategories(categoryMap) {
        subcategoryList.innerHTML = "";
        const selectedCats = [...document.querySelectorAll(".category-filter:checked")].map(cb => cb.value);
        selectedCats.forEach(cat => {
          const subs = categoryMap.get(cat) || new Set();
          subs.forEach(sub => {
            const li = document.createElement("li");
            const lbl = document.createElement("label");
            lbl.innerHTML = `<input type='checkbox' class='subcategory-filter' value='${sub}' data-category='${cat}'/> <span>${sub}</span>`;
            li.appendChild(lbl);
            subcategoryList.appendChild(li);
          });
        });
        document.querySelectorAll(".subcategory-filter").forEach(cb =>
          cb.addEventListener("change", applyFilters)
        );
        applyFilters();
      }
  
      // Render product cards
      function renderProducts(products) {
        productSection.innerHTML = "";
        if (!products.length) {
          productSection.innerHTML = "<p>No products match the selected filters.</p>";
          return;
        }
        products.forEach(product => {
          const img = product.product_images?.startsWith("/")
            ? `data:image/jpeg;base64,${product.product_images}`
            : `data:image/jpeg;base64,${product.product_images}`;
          const data = btoa(unescape(encodeURIComponent(JSON.stringify({ productIds: [product.id], userId: sessionStorage.getItem('user_id') }))));
          const idEnc = btoa(`${product.id}-piescakes`);
          const html = `
            <div class='product-card'>
              <a href='/product/${idEnc}'>
                <div class='product-image'><img src='${img}' alt='${product.name}' loading='lazy'/></div>
              </a>
              <div class='product-info'>
                <h4 style='color:grey;margin:0;'>${product.category.name}</h4>
                <h3 style='margin:5px 0;'>${product.name}</h3>
                <p class='price' style='margin:5px 0;'>
                  <span class='current-price' style='color:orange;font-weight:bold;'>₹${(product.price - (product.discount_price||0)).toFixed(2)}</span>
                  ${product.discount_price?`<span class='old-price' style='text-decoration:line-through;color:grey;margin-left:8px;'>₹${product.price.toFixed(2)}</span>`:''}
                </p>
                <div class='rating' style='color:#FFD700;font-size:1.2em;margin-bottom:10px;width:100%'>★★★★★</div>
                <div class='buttons' style='display:flex;gap:10px;'>
                  <button class='add-to-cart' style='background:orange;color:white;padding:8px 12px;border:none;border-radius:5px;font-weight:bold;' onclick="addToCart('${data}')">ADD TO CART</button>
                  <button class='buy-now' style='background:#4a3f3f;color:white;padding:8px 12px;border:none;border-radius:5px;font-weight:bold;'>BUY NOW</button>
                </div>
              </div>
            </div>`;
          productSection.insertAdjacentHTML('beforeend', html);
        });
      }
  
      // Filter logic
      function applyFilters() {
        const selectedCategories = [...document.querySelectorAll(".category-filter:checked")].map(cb => cb.value);
        const selectedSubCategories = [...document.querySelectorAll(".subcategory-filter:checked")].map(cb => cb.value);
        const selectedWeights = [...document.querySelectorAll(".weight-filter:checked")].map(cb => cb.value);
        const selectedTags = [...tagSpans].filter(span => span.classList.contains('active')).map(span => span.textContent.trim().toLowerCase());
        const maxPrice = parseFloat(priceRange.value);
  
        const filtered = allProducts.filter(p => {
          const parent = p.category.parent?.name;
          const cat = parent || p.category.name;
          const sub = parent ? p.category.name : null;
  
          const isCatSel = selectedCategories.includes(cat);
          const isSubSel = selectedSubCategories.includes(sub);
  
          const categoryMatch = !selectedCategories.length || isCatSel || isSubSel;
          const subCategoryMatch = !selectedSubCategories.length || isSubSel;
          const weightMatch = !selectedWeights.length || selectedWeights.includes(p.serving_size?.toLowerCase().trim());
          const priceMatch = parseFloat(p.price) <= maxPrice;
          const tagsMatch = !selectedTags.length || selectedTags.some(t => (p.tags||"" ).toLowerCase().includes(t));
  
          return categoryMatch && subCategoryMatch && weightMatch && priceMatch && tagsMatch;
        });
  
        renderProducts(filtered);
      }
  
      // Price & tag listeners
      priceRange.addEventListener('input', applyFilters);
      tagSpans.forEach(span => {
        span.style.cursor = 'pointer';
        span.addEventListener('click', () => { span.classList.toggle('active'); applyFilters(); });
      });
    });
  
    function addToCart(encoded) {
      const { productIds, userId } = JSON.parse(decodeURIComponent(escape(atob(encoded))));
      if (!userId) { showToast('Please login to add items to the cart','danger'); return; }
      const cartItems = productIds.map(id => ({ product: id, quantity: 1 }));
      fetch('/api/add-to-cart/', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId, cartItems })
      }).then(r=>r.json()).then(d=> showToast(d.error?'Failed to add products to cart.':'Products added to cart successfully!',''+(d.error?'danger':'success')))
      .catch(e=>{ console.error(e); showToast('An error occurred while adding to cart.','danger'); });
    }
  </script>
  

<script>
    const rangeInput = document.getElementById('price-range');
    const priceDisplay = document.getElementById('priceValue');
    
    rangeInput.addEventListener('input', () => {
        priceDisplay.textContent = rangeInput.value;
    });
</script>
    
{% include "frontend/bestseller.html" %}
{% include "frontend/adds.html" %}
{% include "frontend/new-arrivals.html" %}
{% include "frontend/baked-delight.html" %}
{% include "frontend/why-choose-us.html" %}
{% include "frontend/popular-picke.html" %}
{% endblock %}