{% extends "frontend/base.html" %}
{% block content %}
{% include "frontend/nav.html" %}

<div class="margin-bottom:30px;" style="float: right;margin-top: 20px;margin-right: 20px;font-size: 20px;">
<b>
    <div class="mobile-filter-toggle" id="mobile-filter-toggle" onclick="toggleFilter()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" y1="21" x2="4" y2="14"></line>
            <line x1="4" y1="10" x2="4" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12" y2="3"></line>
            <line x1="20" y1="21" x2="20" y2="16"></line>
            <line x1="20" y1="12" x2="20" y2="3"></line>
          </svg>
    </div>

</b>
</div>

<section class="categories-product">
    <div class="filter-sidebar" id="filter-sidebar-main">
        <!-- CATEGORY FILTER -->
        <div class="filter-section" id="category-filters">
            <h3>Category</h3>
            <ul>
                <li><input type="checkbox" value="Cakes"> Cakes</li>
                <li><input type="checkbox" value="Cupcakes & Muffins"> Cupcakes & Muffins</li>
                <li><input type="checkbox" value="Pies & Tarts"> Pies & Tarts</li>
                <li><input type="checkbox" value="Desserts"> Desserts</li>
                <li><input type="checkbox" value="Croissants"> Croissants</li>
                <li><input type="checkbox" value="Snacks"> Snacks</li>
                <li><input type="checkbox" value="Food Menu"> Food Menu</li>
                <li><input type="checkbox" value="Beverages"> Beverages</li>
            </ul>
        </div>

        <!-- WEIGHT FILTER -->
        <div class="filter-section" id="weight-filters">
            <h3>Weight</h3>
            <ul>
                <li><input type="checkbox" value="1 Slice"> 1 Slice</li>
                <li><input type="checkbox" value="2 Slice"> 2 Slice</li>
                <li><input type="checkbox" value="200g"> 200g</li>
                <li><input type="checkbox" value="250g"> 250g</li>
                <li><input type="checkbox" value="500g"> 500g</li>
                <li><input type="checkbox" value="1000g"> 1000g</li>
                <li><input type="checkbox" value="Combo"> Combo</li>
            </ul>
        </div>

        <!-- PRICE FILTER -->
        <div class="filter-section">
            <label for="priceRange">Price: ₹<span id="priceValue">0</span></label>
            <input type="range" min="0" max="20000" value="350" id="price-range">
        </div>

        <!-- TAGS -->
        <div class="filter-section">
            <h3>Tags</h3>
            <div class="tags">
                <span>Cakes</span>
                <span>Cookies</span>
                <span>Pastries</span>
                <span>Cupcakes</span>
                <span>Brownies</span>
                <span>Breads</span>
                <span>Muffins</span>
                <span>Desserts</span>
                <span>Custom Cakes</span>
                <span>Eggless & Vegan</span>
            </div>
        </div>
    </div>

    <!-- PRODUCTS -->
    <div class="product-section">
        <div class="product-card">
        </div>
    </div>
</section>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const apiUrl = "/api/products-list/?pageSize=10";
        let allProducts = [];
    
        // Elements
        const productSection = document.querySelector(".product-section");
        const categoryFilterContainer = document.querySelector("#category-filters ul");
        const weightInputs = document.querySelectorAll("#weight-filters input[type='checkbox']");
        const priceRange = document.querySelector("#price-range");
        const tagSpans = document.querySelectorAll(".tags span");
    
        // Fetch products
        fetch(apiUrl)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    allProducts = data.products.products;
    
                    // Step 1: Build unique category filters
                    const uniqueCategories = new Set();
                    allProducts.forEach(product => {
                        if (product.category && product.category.name) {
                            uniqueCategories.add(product.category.name);
                        }
                    });
    
                    // Step 2: Render category checkboxes dynamically
                    categoryFilterContainer.innerHTML = "";
                    uniqueCategories.forEach(categoryName => {
                        const li = document.createElement("li");
                        li.innerHTML = `
                            <input type="checkbox" value="${categoryName}"> ${categoryName}
                        `;
                        categoryFilterContainer.appendChild(li);
                    });
    
                    // Step 3: Add event listeners to new checkboxes
                    const categoryInputs = categoryFilterContainer.querySelectorAll("input[type='checkbox']");
                    categoryInputs.forEach(input => {
                        input.addEventListener("change", applyFilters);
                    });
    
                    renderProducts(allProducts);
                }
            });
    
        // Render products
        function renderProducts(products) {
            productSection.innerHTML = "";
    
            if (!products.length) {
                productSection.innerHTML = "<p>No products match the selected filters.</p>";
                return;
            }
    
            products.forEach(product => {
                const imgSrc = product.product_images?.startsWith("/") 
                    ? `data:image/jpeg;base64,${product.product_images}`
                    : product.product_images || "default.jpg";

                    let product_ids = [];
                    product_ids.push(product.id);  // or whatever ID you're pushing
                    let user_id = sessionStorage.getItem('user_id');

                    sendData = {
                        "productIds": product_ids,
                        "userId": user_id
                    }

                    const json_data = JSON.stringify(sendData);
                    const encoded_data = btoa(unescape(encodeURIComponent(json_data)));
                    const encodedId = btoa(`${product.id}-piescakes`);
                const productHTML = `
                    <div class="product-card">
                        <a href="/product/${encodedId}">
                            <div class="product-image">
                                <img src="${imgSrc}" alt="${product.name}">
                            </div>
                            <div class="product-info">
                                <h4 style="color: grey; margin: 0;">${product.category.name}</h4>
                                <h3 style="margin: 5px 0;">${product.name}</h3>
                                <p class="price" style="margin: 5px 0;">
                                    <span class="current-price" style="color: orange; font-weight: bold;">
                                        ₹${product.discount_price ? (product.price - product.discount_price).toFixed(2) : product.price.toFixed(2)}
                                    </span>
                                    ${product.discount_price ? `<span class="old-price" style="text-decoration: line-through; color: grey; margin-left: 8px;">₹${product.price.toFixed(2)}</span>` : ''}
                                </p>
                                <div class="rating" style="color: #FFD700; font-size: 1.2em; margin-bottom: 10px;">
                                    ★★★★★
                                </div>
                                <div class="buttons" style="display: flex; gap: 10px;">
                                    <button class="add-to-cart" style="background-color: orange; color: white; padding: 8px 12px; border: none; border-radius: 5px; font-weight: bold;" onclick="addToCart('${encoded_data}')">ADD TO CART</button>
                                    <button class="buy-now" style="background-color: #4a3f3f; color: white; padding: 8px 12px; border: none; border-radius: 5px; font-weight: bold;">BUY NOW</button>
                                </div>
                            </div>
                        </a>
                    </div>`;
    
                productSection.insertAdjacentHTML("beforeend", productHTML);
            });
        }
    
        // Filter logic
        function applyFilters() {
            const categoryInputs = document.querySelectorAll("#category-filters input[type='checkbox']");
            console.log("categoryInputs", [...categoryInputs]);
            const selectedCategories = [...categoryInputs].filter(i => i.checked).map(i => i.value);
            const selectedWeights = [...weightInputs].filter(i => i.checked).map(i => i.value.toLowerCase());
            const selectedTags = [...tagSpans].filter(span => span.classList.contains("active")).map(span => span.textContent.trim().toLowerCase());
            const maxPrice = parseFloat(priceRange.value);
    
            const filtered = allProducts.filter(p => {
                const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(p.category.name);
                const weightMatch = selectedWeights.length === 0 || selectedWeights.includes(p.cake_size?.toLowerCase());
                const priceMatch = parseFloat(p.price) <= maxPrice;
                const tagsMatch = selectedTags.length === 0 || selectedTags.some(tag => p.tags?.toLowerCase().includes(tag));

                return categoryMatch && weightMatch && priceMatch && tagsMatch;
            });
    
            renderProducts(filtered);
        }
    
        priceRange.addEventListener("input", applyFilters);
    
        tagSpans.forEach(span => {
            span.style.cursor = "pointer";
            span.addEventListener("click", () => {
                span.classList.toggle("active");
                applyFilters();
            });
        });
    });


function addToCart(encodedData) {
    // Decode the base64-encoded data
    const decodedData = JSON.parse(atob(encodedData));
    // Extract productIds and userId from the decoded data
    const productIds = decodedData.productIds;
    const userId = decodedData.userId;

    // Prepare the data to send in the POST request
    const data = {
        userId: userId,
        productIds: productIds
    };

    // Send a POST request to the API to add products to the cart
    fetch('/api/add-to-cart/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)  // Send the data as a JSON string
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            showToast("Products added to cart successfully!", "success");
        } else {
            showToast("Failed to add products to cart.", "danger");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        showToast("An error occurred while adding to cart.", "danger");
    });
}

    </script>
    <script>
        const rangeInput = document.getElementById('price-range');
        const priceDisplay = document.getElementById('priceValue');
      
        rangeInput.addEventListener('input', () => {
          priceDisplay.textContent = rangeInput.value;
        });
      </script>
    
{% include "frontend/bestseller.html" %}
{% include "frontend/adds.html" %}
{% include "frontend/new-arrivals.html" %}
{% include "frontend/baked-delight.html" %}
{% include "frontend/why-choose-us.html" %}
{% include "frontend/popular-picke.html" %}
{% endblock %}