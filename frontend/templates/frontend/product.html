{% extends "frontend/base.html" %}
{% block content %}
{% include "frontend/nav.html" %}

<section class="product-section">
    <div class="product-container">
        <div class="product-image">
          <img id="product-image" src="" alt="" loading="lazy">
        </div>
      
        <div class="product-details">
          <h1 id="product-name"></h1>
          <div class="rating">⭐ ⭐ ⭐ ⭐ ☆</div>
          <p class="price" id="product-price"></p>
          <p id="product-description"></p>
      
          <div class="weight-selection">
            <h3>WEIGHT</h3>
            <button class="weight active" id="product-weight"></button>
          </div>
      
          <div style="text-decoration: none;color: inherit;" class="action-row">
            <div class="quantity" style="max-width: 100px;">
                <button class="minus">-</button>
                <input type="text" value="1" class="quantity-input" id="product-page-quantity">
                <button class="plus">+</button>
              </div>
          
            <button class="add-to-cart" id="add-to-cart-btn">ADD TO CART</button>
          </div>
        </div>
      </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1. Grab the last segment of the path (e.g. "Ni1waWVzY2FrZXM=")
    const segments = window.location.pathname.split('/').filter(Boolean);
    const encoded = segments[segments.length - 1];

    // 2. Base64-decode it: e.g. "6-piescakes"
    let decoded;
    try {
      decoded = atob(encoded);
    } catch (e) {
      console.error('Failed to decode ID from URL:', e);
      return;
    }

    // 3. Split into [id, slug]
    const [id, ...slugParts] = decoded.split('-');
    const slug = slugParts.join('-');  // if you ever need the slug
    fetch(`/api/products/${encoded}/`)
    .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
    })
    .then(data => {
        const product = data.products[0];

        // Set image
        const imageEl = document.getElementById('product-image');
        if (product.product_images) {
        imageEl.src = `data:image/png;base64,${product.product_images}`;
        imageEl.alt = product.name;
        }

        // Set name, price, description, weight
        document.getElementById('product-name').textContent = product.name;
        document.getElementById('product-price').textContent = `₹${product.price}`;
        document.getElementById('product-description').textContent = product.description;

        const weightText = product.weight || product.serving_size || 'N/A';
        document.getElementById('product-weight').textContent = weightText;

        // Set button data-id
        const cartBtn = document.getElementById('add-to-cart-btn');
        cartBtn.setAttribute('data-encoded', product.id);
    })
    .catch(err => {
        console.error('Error fetching product:', err);
        // TODO: Display a user-friendly "product not found" message here
    });

  });
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Quantity Button Logic
        const quantityInput = document.querySelector('.quantity-input');
        const minusBtn = document.querySelector('.minus');
        const plusBtn = document.querySelector('.plus');
    
        minusBtn.addEventListener('click', () => {
            let currentQty = parseInt(quantityInput.value);
            if (currentQty > 1) quantityInput.value = currentQty - 1;
        });
    
        plusBtn.addEventListener('click', () => {
            let currentQty = parseInt(quantityInput.value);
            quantityInput.value = currentQty + 1;
        });
    
        document.querySelector('.add-to-cart').addEventListener('click', function () {
            const productId = this.getAttribute('data-encoded');

            const userId = sessionStorage.getItem('user_id');
            const quantityInput = document.getElementById('product-page-quantity');
            const quantity = parseInt(quantityInput.value) || 1;

            // If user not logged in, show message
            if (!userId) {
                showToast("Please login to add item to cart", "danger");
                return;
            }

            const cartItems = [{
                product: productId,
                quantity: quantity
            }];
            

            fetch('/api/add-to-cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: userId,
                    cartItems: cartItems
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data && !data.error) {
                    showToast("Products added to cart successfully!", "success");
                    window.location.href = "/cart";
                } else {
                    showToast("Failed to add products to cart.", "danger");
                }
            })
            .catch(error => {
                console.error("Error adding to cart:", error);
                showToast("Something went wrong.", "danger");
            });
        });
    });
    </script>
    

<section class="recommendation-section">
    <div class="heading">
        <h2>You May <span>Also Like</span></h2>
        <p>Looking for more indulgence? Try these delicious treats handpicked for you!</p>
    </div>

    <div class="product-grid" id="recommendationGrid">
        <div class="product-card">
            <img src="https://s3-alpha-sig.figma.com/img/ef04/3dbb/2b7cccec16c019ce86a585e7241463b7?Expires=1743379200&Key-Pair-Id=APKAQ4GOSFWCW27IBOMQ&Signature=DJ562FCnN-yWQ64l24lNAcj8fPbUAgUwgLdMgaFLaMfEyqrtCy7O-q8iGr9Y6Z~bP4egQDJA8EhUEaf2T1OOabx4hEpS2JpK72jkmysv0eYVWoSa0ENnorj~ouV10TkhwCaJ8Kgxs2PV9bgppmVKdezl3sOMtVLlrDKUBQWumUF55COYTbkwvLgm9Pl9xUTQXwUH~my1zs4L937crgOQKxhvikYoLKxYnziBPPQodTyvA9RZaBNNok~GgOU1ZDSTIsLiVOZ7dUuKuJZmoHs4ZH4Vb70cZLs4UILpnKgrsEKxlx-loulQo-X0ZjFoZjG2TXvF24al5cOl5d6kPHV3IQ__" alt="French Vanilla Bomboloni">
            <div class="product-info">
                <h3>FRENCH VANILLA BOMBOLONI</h3>
                <p class="category">Desserts</p>
                <p class="price">₹200.00</p>
            </div>
        </div>

        <div class="product-card">
            <img src="https://s3-alpha-sig.figma.com/img/45a5/b7c7/495c436c36424bfee5a0384fa68331fa?Expires=1743379200&Key-Pair-Id=APKAQ4GOSFWCW27IBOMQ&Signature=qdDBiU8FClumOXSW7aRdSkE3vMcXBwknkRAm5AF0kF9SbtyxoVI5fVW01A03M7mBBPYeXYSAeRGgA5GGl69YGqX14DgA0LjYU-uJ790XtPrjX6ljncUltu6oPys4xjk0O8CVXXYcLbvR0NqElMDuNH4lhS85jYXjsCwLfPC5G5DQWkw8Wqvz5kN2MtWcXQwmiiwqYfnZ3eXGEOxF5BLsfo6g5lU2PLItEF7g-0pdq9yImEnR2MMZY4ZDRPrPpVg6Pc0Tubx53tcY9P3RjU2gJVV6vvC6eLBJ18eA1IMyArozke9BqTBhXJ31yH0dbptwLTUfcrfVuiKcXouVz-IIzA__" alt="Blueberry Cheese Cake">
            <div class="product-info">
                <h3>BLUEBERRY CHEESE CAKE</h3>
                <p class="category">Cakes</p>
                <p class="price">₹200.00</p>
            </div>
        </div>

        <div class="product-card">
            <img src="https://s3-alpha-sig.figma.com/img/8a20/53cf/69326bca05412c52363c504c81ab5637?Expires=1743379200&Key-Pair-Id=APKAQ4GOSFWCW27IBOMQ&Signature=WgWf-H23qT3XJUGV2z3hJ3A4mDyPveHoaCBMgL6-hQiRmWj4ni2VR4kR2BwirySZpNofDjfMGEOxMz5AzoeHWFwVexqhE1GYybgzF19JWyw4BFoJ4ZzmjKK9G0xy~kxd7cYyMgtju2eX5IQ2pHBektzEu0FDb9z5s7~fTNQvI5OE1rr-FC8ibgUTgZzIFww06uSr1-3pZBkASO~UlfYnI~DEpEfNB-fuA9fwQm-vN8noaSLOI9eKw~3eVgUWWp5zE74qp1zziW452XWp6KzhLu-9gXrdbxxVHhwoXJqee7~2PW010f3JBjpNi5jhsmvIYDfMN6GYwEgFQgsKS7GrcQ__" alt="Classic Hot Chocolate">
            <div class="product-info">
                <h3>CLASSIC HOT CHOCOLATE</h3>
                <p class="category">Beverages</p>
                <p class="price">₹180.00</p>
            </div>
        </div>

        <div class="product-card">
            <img src="https://s3-alpha-sig.figma.com/img/f9b3/0e57/78ef8132c44847533f3a6134ad7b20cb?Expires=1743379200&Key-Pair-Id=APKAQ4GOSFWCW27IBOMQ&Signature=TzGfKdCvQDg4Pn4EC8Of6UsyoJcssjiN~sqpnBYb17pu0-xCwLeXRvxKfuOE09kSiAry1ooSjJk4DgJFLRze27b1L5PFFU0lc56rz91iTcGuc31JUA~fqip54chuktybe8nQhEyoy0EjtAsC7TblatHMxSWKIK0mhuesc95BcOq2huwRXlKkG4R4IOwtX39B4hgW~m1z9jwbbObtT6UpP7Ls-w5TqRcOzsISrHbCj7vrIJXBviuwLT3P5jjeno-dSz8angXYyXfntn~Ys8eFIZ6kIHx6~CZG4cLtllEEL-NXAIDSwjqcMMQ~NJto7~6y6yfQP9Ty6PurGgDocEgL6A__" alt="Biscoff Brownies">
            <div class="product-info">
                <h3>BISCOFF BROWNIES</h3>
                <p class="category">Desserts</p>
                <p class="price">₹150.00</p>
            </div>
        </div>
    </div>
</section>
<script>
    document.addEventListener("DOMContentLoaded", () => {
      loadRecommendations();
    });
    
    async function loadRecommendations() {
      try {
        const res = await fetch("/api/products-list/?page=1&pageSize=1000");
        if (!res.ok) throw new Error("Network response was not ok");
        const data = await res.json();
    
        // All products array
        const all = data.products.products;
    
        // Take the last 4 entries
        const lastFour = all.slice(-4);
    
        // Find the grid and clear it
        const grid = document.getElementById("recommendationGrid");
        grid.innerHTML = "";
    
        lastFour.forEach(prod => {
          // Build your card
          const card = document.createElement("div");
          card.className = "product-card";
          const encodedId = btoa(`${prod.id}-piescakes`); // Encode ID same way as in your app

            const imgSrc = prod.product_images
            ? `data:image/png;base64,${prod.product_images}`
            : "placeholder.jpg"; // fallback if no image

            card.innerHTML = `
            <div class="inner-product-tag" style="border-radius:0px;text-align: left !important;">
                <a href="/product/${encodedId}">
                <img src="${imgSrc}" alt="${prod.name}" loading="lazy" />
                </a>
                <div class="product-info">
                <span class="category mb-1" style="text-align: left !important;">${prod.category?.name || "Uncategorized"}</span>

                <h4 class="mb-1 product-heading">
                    <a href="product/${encodedId}" style="
                    text-decoration: none;
                    font-size: 14px !important;
                    font-weight: bold;
                    text-align: left !important;
                    color: #5A3E36;
                    margin: 0;
                    ">
                    ${prod.name}
                    </a>
                </h4>

                <div class="rating mb-1">⭐⭐⭐⭐⭐</div>

                <p class="price mb-1">
                    ₹${prod.discount_price ? (prod.price - prod.discount_price).toFixed(2) : prod.price.toFixed(2)}
                    ${prod.discount_price ? `<strike>₹${prod.price.toFixed(2)}</strike>` : ""}
                </p>
                </div>
            </div>
            `;

    
          grid.appendChild(card);
        });
      } catch (err) {
        console.error("Failed to load recommendations:", err);
      }
    }
    
    
    </script>
    
{% include "frontend/why-choose-us.html" %}
{% endblock %}